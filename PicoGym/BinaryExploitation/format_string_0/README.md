# Writeup: format string 0

## Overview

This challenge involves exploiting a format string vulnerability to retrieve a flag. The vulnerability arises from improper handling of format strings in user input, leading to the potential for a segmentation fault. Our goal is to trigger a crash in the program to access the flag.

## Analysis

### Code Overview

Upon examining the code, we observe that the `sigsegv_handler` function is designed to handle segmentation faults. This function prints out the flag when a segmentation fault occurs.

```c
void sigsegv_handler(int sig) {
    printf("\n%s\n", flag);
    fflush(stdout);
    exit(1);
}
```

A segmentation fault (`SIGSEGV`) occurs when the program accesses invalid memory, causing it to crash. Our task is to exploit this behavior to get the flag.


### Key Functions and Vulnerabilities
1. `serve_patrick` Function:

- This function presents a menu to the user and allows them to choose from several burger options:

```c
char *menu1[3] = {"Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe"};
```

- The code then prints the user's choice and measures the length of the printed string:

```c
int count = printf(choice1);
if (count > 2 * BUFSIZE) {
    serve_bob();
}
```

- If the count exceeds twice the buffer size (`2 * BUFSIZE`), the program calls the `serve_bob` function.

2. `serve_bob` Function:

- This function presents another menu with different burger options:
```c
char *menu2[3] = {"Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak"};
```

- The function then prints the user's choice directly using `printf(choice2);`, which can lead to format string vulnerabilities.

## Exploitation Strategy
1. First Menu:

- We need to choose a burger option that will make the `count` from `printf` exceed `2 * BUFSIZE`. The menu option `Gr%114d_Cheese` is chosen because `%114d` in the format string will create a space of 114 characters, increasing the output length significantly:
- `Gr%114d_Cheese` will print "Gr" followed by 114 spaces and then "Cheese", resulting in a large output length.

2. Second Menu:

- After passing the first selection, we need to exploit the format string vulnerability to cause a segmentation fault. The menu option `Cla%sic_Che%s%steak` is chosen because:
- `%s` will print the contents of the stack. When there are no more stack contents to print, `printf` may attempt to access invalid memory, causing a crash.

## Alternative Exploit Method
It was also observed that inputting exactly 48 bytes during the first menu selection directly causes a buffer overflow, leading to a segmentation fault and triggering the flag output. This behavior is due to how the input size interacts with the buffer and memory layout, causing a crash when the program attempts to process or access memory beyond the allocated buffer size.

## Conclusion
To solve the challenge, you can either:

1. Use the format string vulnerabilities in `Gr%114d_Cheese` and `Cla%sic_Che%s%steak` to trigger a segmentation fault and reveal the flag.
2. Directly input 48 bytes during the first menu selection to cause a buffer overflow, leading to a crash and displaying the flag.
