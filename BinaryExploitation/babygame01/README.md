# Writeup: babygame01

## Overview

This challenge involves understanding of a C program and exploiting a buffer overflow vulnerability to modify a local variable and reveal a flag.

## Analysis

### Code Overview

Since the challenge only provided a binary file, the analysis was conducted using Ghidra.

The main function (with some renamed variables for clarity):

```c
undefined4 main(void)

{
  int inputChar;
  undefined4 uVar1;
  int in_GS_OFFSET;
  int y-coor;
  int x-coor;
  char flag_status;
  undefined map [2700];
  int local_14;
  undefined *local_10;
  
  local_10 = &stack0x00000004;
  local_14 = *(int *)(in_GS_OFFSET + 0x14);
  init_player(&y-coor);
  init_map(map,&y-coor);
  print_map(map,&y-coor);
  signal(2,sigint_handler);
  do {
    do {
      inputChar = getchar();
      move_player(&y-coor,(int)(char)inputChar,map);
      print_map(map,&y-coor);
    } while (y-coor != 0x1d);
  } while (x-coor != 0x59);
  puts("You win!");
  if (flag_status != '\0') {
    puts("flage");
    win();
    fflush(_stdout);
  }
  uVar1 = 0;
  if (local_14 != *(int *)(in_GS_OFFSET + 0x14)) {
    uVar1 = __stack_chk_fail_local();
  }
  return uVar1;
}
```

The program displays a tile map with a player tile and an end tile.

Example output:

```terminal
Player position: 4 4
End tile position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
....@.....................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X

```

Upon checking the move_player function, there are three type of actions based on user input:
1. `'l'` followed by a character to set the player tile
2. `'p'` to move the player to  the end tile 
3. `'w'`,`'a'`,`'s'`,`'d'` to move the player vertically and horizontally

```c
void move_player(int *y-coor,char param_2,int param_3)

{
  int iVar1;
  
  if (param_2 == 'l') {
    iVar1 = getchar();
    player_tile = (undefined)iVar1;
  }
  if (param_2 == 'p') {
    solve_round(param_3,y-coor);
  }
  *(undefined *)(*y-coor * 0x5a + param_3 + y-coor[1]) = 0x2e;
  if (param_2 == 'w') {
    *y-coor = *y-coor + -1;
  }
  else if (param_2 == 's') {
    *y-coor = *y-coor + 1;
  }
  else if (param_2 == 'a') {
    y-coor[1] = y-coor[1] + -1;
  }
  else if (param_2 == 'd') {
    y-coor[1] = y-coor[1] + 1;
  }
  *(undefined *)(*y-coor * 0x5a + param_3 + y-coor[1]) = player_tile;
  return;
}
```

After the player reaches the end tile, the program checks the `flag_status` variable and output flag if it is not null:

```c
  if (flag_status != '\0') {
    puts("flage");
    win();
    fflush(_stdout);
  }
```

### Vulnerabilities
- Buffer Overflow:
The absence of bounds checking on the map allows the player pointer to move outside thhe map array, leading to a buffer overflow.

## Exploitation Strategy

1. Perform a buffer overflow to modify `flag_status` to pass the condition check and reveal the flag.

## Exploitation Steps

Since the variable `flag_status` is just above the variable `map` during initialisation, `flag_status` could possibly under the `map` in the stack.

1. **Move the Player**: Start moving the player to the top-left corner (position `(0,0)`) using the 'w' and 'a' commands.
2. **Overflow the Buffer**: Inputting 4 'a' causes the buffer overflow and modifies `flag_status`.
3. Move to End Tile: Use the 'p' command to move the player to the end tile.
4. **Reaveal the Flag**: The `flag_status` is checked and reveals the flag.

## Conclusion
By exploiting the buffer overflow vulnerability, you can modify the `flag_status` variable and reveal the flag.
